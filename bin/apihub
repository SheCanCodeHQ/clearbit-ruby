#!/usr/bin/env ruby

require 'apihub'
require 'json'
require 'optparse'

begin
  require 'awesome_print'
rescue LoadError
  def ap(value)
    puts JSON.pretty_generate(value)
  end
end

options = {}
values  = {}

parser  = OptionParser.new do |opts|
  opts.banner = "Usage: apihub [person|company] [options]"

  opts.on("--twitter HANDLE", String, "Twitter handle") do |v|
    values[:twitter] = v
  end

  opts.on("--github HANDLE", String, "GitHub handle") do |v|
    values[:github] = v
  end

  opts.on("--email EMAIL", String, "Email") do |v|
    values[:email] = v
  end

  opts.on("--domain DOMAIN", String, "Domain") do |v|
    values[:domain] = v
  end

  opts.on("--api-key KEY", String, "APIHub") do |v|
    options[:api_key] = v
  end
end

parser.parse!

case ARGV[0]
when 'person'
  entity = APIHub::Person
when 'company'
  entity = APIHub::Company
else
  puts parser
  exit
end

if values == {}
  puts parser
  exit
end

if key = ENV['APIHUB_KEY']
  options[:api_key] ||= key
end

object = entity.find(values, options)

if object && object.pending?
  puts 'Lookup queued'
elsif object
  ap object.to_hash
else
  puts 'Not found'
end